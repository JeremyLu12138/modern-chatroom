<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>聊天室</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <button id="toggle-theme">🌙 夜间模式</button>
  <h1>欢迎来到聊天室</h1>

  <div id="chat-box">
    <ul id="messages"></ul>
  </div>

  <div id="online-box">
    <h3>在线用户</h3>
    <div id="user-count"></div>
    <ul id="online-users"></ul>
  </div>

  <div id="input-area">
    <input id="msgInput" placeholder="输入你的消息..." />
    <button id="emojiBtn">😀</button>
    <button id="uploadBtn">📎</button>
    <input type="file" id="fileInput" style="display: none" />
    <button id="sendBtn">发送</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  window.onload = () => {
    const socket = io();
  
    // 获取昵称（无本地记忆）
    let nickname = '';
    while (!nickname) {
      nickname = prompt("请输入你的昵称：")?.trim();
    }
  
    socket.emit('join', nickname);
  
    // DOM 元素
    const input = document.getElementById('msgInput');
    const button = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const onlineList = document.getElementById('online-users');
    const userCountBox = document.getElementById('user-count');
    let privateRecipient = null;

    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    uploadBtn.onclick = () => fileInput.click();

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        socket.emit('file message', {
          from: nickname,
          filename: file.name,
          filetype: file.type,
          content: reader.result
        });
      };
      reader.readAsDataURL(file);
    });


  
    // 点击发送按钮
    button.onclick = () => {
      const msg = input.value.trim();
      if (!msg) return;
  
      const payload = {
        id: Date.now(),
        name: nickname,
        text: msg,
        time: new Date().toLocaleTimeString()
      };
  
      if (privateRecipient) {
        socket.emit('private message', { to: privateRecipient.id, msg: payload });
      } else {
        socket.emit('chat message', payload);
      }
  
      input.value = '';
    };
  
    // 回车快捷发送
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') button.click();
    });
  
    // 接收群聊消息
    socket.on('chat message', ({ id, name, text, time }) => {
      const li = document.createElement('li');
      li.className = name === nickname ? 'my-message' : 'other-message';
      li.innerHTML = `
        <div>
          <strong>[${name}]</strong>
          <span class="timestamp">（${time}）</span>
        </div>
        <div>${text}</div>
      `;
      messages.appendChild(li);
    });

  
    // 接收私聊消息
    socket.on('private message', ({ from, msg }) => {
      const li = document.createElement('li');
      li.className = from === nickname ? 'my-message' : 'other-message';
      li.innerHTML = `
        <div>
          <strong>[私聊][${from}]</strong>
          <span class="timestamp">（${msg.time}）</span>
        </div>
        <div>${msg.text}</div>
      `;
      messages.appendChild(li);
    });

    // 系统消息
    socket.on('system message', ({ text, time }) => {
      const li = document.createElement('li');
      li.className = 'system-message';
      li.innerHTML = `
        <div>${text}</div>
        <div class="timestamp">（${time}）</div>
      `;
      messages.appendChild(li);
    });
  
    // 显示在线用户列表
    socket.on('online users', (users) => {
      onlineList.innerHTML = '';
      userCountBox.textContent = `当前在线：${users.length} 人`;
  
      users.forEach(user => {
        const li = document.createElement('li');
        const isMe = user.name === nickname;
        li.textContent = isMe ? `${user.name}（我）` : user.name;
        li.setAttribute('data-id', user.id);
        if (isMe) li.style.fontWeight = 'bold';
  
        // 点击设置/取消私聊对象
        li.onclick = () => {
          if (privateRecipient && privateRecipient.id === user.id) {
            privateRecipient = null;
            li.style.backgroundColor = '';
            alert('已取消私聊');
          } else {
            privateRecipient = user;
            document.querySelectorAll('#online-users li').forEach(el => {
              el.style.backgroundColor = '';
            });
            li.style.backgroundColor = '#ffffcc';
            alert('你正在私聊：' + user.name);
          }
        };
  
        onlineList.appendChild(li);
      });
    });

    socket.on('file message', (file) => {
      const li = document.createElement('li');
      li.className = file.from === nickname ? 'my-message' : 'other-message';

      let content = '';
      if (file.filetype.startsWith('image/')) {
        content = `<img src="${file.content}" style="max-width: 200px; border-radius: 10px;">`;
      } else {
        content = `<a href="${file.content}" download="${file.filename}">${file.filename}</a>`;
      }

      li.innerHTML = `
        <div>
          <strong>[${file.from}]</strong>
          <span class="timestamp">（${new Date().toLocaleTimeString()}）</span>
        </div>
        <div>${content}</div>
      `;
      messages.appendChild(li);
    });


  };
  </script>
  
  


</body>
</html>

