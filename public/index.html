<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>èŠå¤©å®¤</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <button id="toggle-theme">ğŸŒ™ å¤œé—´æ¨¡å¼</button>
  <h1>æ¬¢è¿æ¥åˆ°èŠå¤©å®¤</h1>

  <div id="chat-box">
    <ul id="messages"></ul>
  </div>

  <div id="online-box">
    <h3>åœ¨çº¿ç”¨æˆ·</h3>
    <div id="user-count"></div>
    <ul id="online-users"></ul>
  </div>

  <div id="input-area">
    <input id="msgInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." />
    <button id="emojiBtn">ğŸ˜€</button>
    <button id="uploadBtn">ğŸ“</button>
    <input type="file" id="fileInput" style="display: none" />
    <button id="sendBtn">å‘é€</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  window.onload = () => {
    const socket = io();
  
    // è·å–æ˜µç§°ï¼ˆæ— æœ¬åœ°è®°å¿†ï¼‰
    let nickname = '';
    while (!nickname) {
      nickname = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š")?.trim();
    }
  
    socket.emit('join', nickname);
  
    // DOM å…ƒç´ 
    const input = document.getElementById('msgInput');
    const button = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const onlineList = document.getElementById('online-users');
    const userCountBox = document.getElementById('user-count');
    let privateRecipient = null;

    const uploadBtn = document.getElementById('uploadBtn');
    const fileInput = document.getElementById('fileInput');

    uploadBtn.onclick = () => fileInput.click();

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        socket.emit('file message', {
          from: nickname,
          filename: file.name,
          filetype: file.type,
          content: reader.result
        });
      };
      reader.readAsDataURL(file);
    });


  
    // ç‚¹å‡»å‘é€æŒ‰é’®
    button.onclick = () => {
      const msg = input.value.trim();
      if (!msg) return;
  
      const payload = {
        id: Date.now(),
        name: nickname,
        text: msg,
        time: new Date().toLocaleTimeString()
      };
  
      if (privateRecipient) {
        socket.emit('private message', { to: privateRecipient.id, msg: payload });
      } else {
        socket.emit('chat message', payload);
      }
  
      input.value = '';
    };
  
    // å›è½¦å¿«æ·å‘é€
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') button.click();
    });
  
    // æ¥æ”¶ç¾¤èŠæ¶ˆæ¯
    socket.on('chat message', ({ id, name, text, time }) => {
      const li = document.createElement('li');
      li.className = name === nickname ? 'my-message' : 'other-message';
      li.innerHTML = `
        <div>
          <strong>[${name}]</strong>
          <span class="timestamp">ï¼ˆ${time}ï¼‰</span>
        </div>
        <div>${text}</div>
      `;
      messages.appendChild(li);
    });

  
    // æ¥æ”¶ç§èŠæ¶ˆæ¯
    socket.on('private message', ({ from, msg }) => {
      const li = document.createElement('li');
      li.className = from === nickname ? 'my-message' : 'other-message';
      li.innerHTML = `
        <div>
          <strong>[ç§èŠ][${from}]</strong>
          <span class="timestamp">ï¼ˆ${msg.time}ï¼‰</span>
        </div>
        <div>${msg.text}</div>
      `;
      messages.appendChild(li);
    });

    // ç³»ç»Ÿæ¶ˆæ¯
    socket.on('system message', ({ text, time }) => {
      const li = document.createElement('li');
      li.className = 'system-message';
      li.innerHTML = `
        <div>${text}</div>
        <div class="timestamp">ï¼ˆ${time}ï¼‰</div>
      `;
      messages.appendChild(li);
    });
  
    // æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·åˆ—è¡¨
    socket.on('online users', (users) => {
      onlineList.innerHTML = '';
      userCountBox.textContent = `å½“å‰åœ¨çº¿ï¼š${users.length} äºº`;
  
      users.forEach(user => {
        const li = document.createElement('li');
        const isMe = user.name === nickname;
        li.textContent = isMe ? `${user.name}ï¼ˆæˆ‘ï¼‰` : user.name;
        li.setAttribute('data-id', user.id);
        if (isMe) li.style.fontWeight = 'bold';
  
        // ç‚¹å‡»è®¾ç½®/å–æ¶ˆç§èŠå¯¹è±¡
        li.onclick = () => {
          if (privateRecipient && privateRecipient.id === user.id) {
            privateRecipient = null;
            li.style.backgroundColor = '';
            alert('å·²å–æ¶ˆç§èŠ');
          } else {
            privateRecipient = user;
            document.querySelectorAll('#online-users li').forEach(el => {
              el.style.backgroundColor = '';
            });
            li.style.backgroundColor = '#ffffcc';
            alert('ä½ æ­£åœ¨ç§èŠï¼š' + user.name);
          }
        };
  
        onlineList.appendChild(li);
      });
    });

    socket.on('file message', (file) => {
      const li = document.createElement('li');
      li.className = file.from === nickname ? 'my-message' : 'other-message';

      let content = '';
      if (file.filetype.startsWith('image/')) {
        content = `<img src="${file.content}" style="max-width: 200px; border-radius: 10px;">`;
      } else {
        content = `<a href="${file.content}" download="${file.filename}">${file.filename}</a>`;
      }

      li.innerHTML = `
        <div>
          <strong>[${file.from}]</strong>
          <span class="timestamp">ï¼ˆ${new Date().toLocaleTimeString()}ï¼‰</span>
        </div>
        <div>${content}</div>
      `;
      messages.appendChild(li);
    });


  };
  </script>
  
  


</body>
</html>

