<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç®€æ´èŠå¤©å®¤</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.4/dist/emoji-button.min.js"></script>

</head>
<body>
  <h1>ğŸ’¬ æ¬¢è¿æ¥åˆ°èŠå¤©å®¤</h1>
  <button id="toggle-theme" style="position: absolute; top: 20px; right: 20px;">ğŸŒ™ å¤œé—´æ¨¡å¼</button>

  <div id="online-box">
    <h3>åœ¨çº¿ç”¨æˆ·</h3>
    <div id="user-count" style="margin-bottom: 6px; color: #666;"></div> <!-- âœ… æ–°å¢è¿™ä¸€è¡Œ -->
    <ul id="online-users"></ul>
  </div>

  <div id="chat-box">
    <ul id="messages"></ul>
  </div>
  <div id="input-area">
    <input id="msgInput" placeholder="è¾“å…¥ä½ çš„æ¶ˆæ¯..." />
    <input type="file" id="fileInput" />
    <button id="emojiBtn">ğŸ˜€</button>

    <button id="sendBtn">å‘é€</button>
  </div>

<script src="/socket.io/socket.io.js"></script>
<script>
    let privateRecipient = null;  // ã€æ–°å¢å…¨å±€å˜é‡ï¼šç”¨äºå­˜å‚¨å½“å‰ç§èŠå¯¹è±¡ã€‘

    const socket = io();

    const onlineList = document.getElementById('online-users');

    const fileInput = document.getElementById('fileInput');

    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        // å‘é€æ–‡ä»¶æ•°æ®
        socket.emit('file message', {
          from: nickname,
          filename: file.name,
          filetype: file.type,
          filesize: file.size,
          content: reader.result   // base64
        });
      };
      reader.readAsDataURL(file);   // âœ… è¯»å–ä¸º base64
    });


    socket.on('online users', (users) => {
      onlineList.innerHTML = '';
      const countBox = document.getElementById('user-count');
      countBox.textContent = `å½“å‰åœ¨çº¿ï¼š${users.length} äºº`;
      users.forEach(user => {
        const item = document.createElement('li');

        const isMe = user.name === nickname;
        item.textContent = isMe ? `${user.name}ï¼ˆæˆ‘ï¼‰` : user.name;

        if (isMe) {
          item.style.fontWeight = 'bold';
          item.style.color = '#4a90e2';
        }

        item.setAttribute('data-id', user.id);
        item.addEventListener('click', () => {
          if (privateRecipient && privateRecipient.id === user.id) {
            privateRecipient = null;
            item.style.backgroundColor = '';
            alert('å–æ¶ˆç§èŠ');
          } else {
            privateRecipient = user;
            document.querySelectorAll('#online-users li').forEach(li => {
              li.style.backgroundColor = '';
            });
            item.style.backgroundColor = '#ffffcc';
            alert('è®¾ç½®ç§èŠå¯¹è±¡ï¼š' + user.name);
          }
        });

      onlineList.appendChild(item);
      });
    });



    // è·å–æ˜µç§°
    let nickname = '';
    while (!nickname) {
    nickname = prompt("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼š");
    nickname = nickname?.trim();
    }

    // åŠ å…¥èŠå¤©å®¤ï¼Œå‘é€æ˜µç§°åˆ°æœåŠ¡ç«¯
    socket.emit('join', nickname);

    const input = document.getElementById('msgInput');
    const button = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');

    const emojiBtn = document.getElementById('emojiBtn');

    const picker = new window.EmojiButton({
      position: 'top-start',
      theme: 'auto'
    });


    picker.on('emoji', emoji => {
      input.value += emoji;
    });

    emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));



    button.onclick = () => {
      const msg = input.value.trim();
      if (msg) {
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        const msgObj = {
          id: Date.now(),       // å”¯ä¸€ ID
          name: nickname,
          text: msg,
          time: timestamp
        };

        if (privateRecipient) {
      // å¦‚æœè®¾ç½®äº†ç§èŠå¯¹è±¡ï¼Œåˆ™åŠ å…¥æ ‡è®°ï¼Œå¹¶å‘é€ç§èŠæ¶ˆæ¯
          msgObj.private = true;      // å¯é€‰ï¼Œç”¨äºåç»­æ ·å¼åˆ¤æ–­
          msgObj.toName = privateRecipient.name;  // æ˜¾ç¤ºç›®æ ‡åå­—
          socket.emit('private message', { to: privateRecipient.id, msg: msgObj });
        } else {
      // å¦åˆ™ï¼ŒæŒ‰å…¬å¼€æ¶ˆæ¯å‘é€
          socket.emit('chat message', msgObj);
        }
      input.value = '';
      }
    };


    socket.on('chat message', ({ id, name, text, time }) => {
      const item = document.createElement('li');
      const isMe = name === nickname;

      item.id = `msg-${id}`;                          // ğŸŸ¦ ç»™ li ä¸€ä¸ªå”¯ä¸€ ID
      item.className = isMe ? 'my-message' : 'other-message';
      item.innerHTML = `<strong>[${name}]</strong> ${text} <span class="timestamp">ï¼ˆ${time}ï¼‰</span>`;

      if (isMe) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'æ’¤å›';
        delBtn.onclick = () => {
          socket.emit('delete message', id);         // ğŸŸ¦ å‘é€åˆ é™¤è¯·æ±‚
        };
        item.appendChild(delBtn);
      }

      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on('file message', (file) => {
      const item = document.createElement('li');
      item.className = file.from === nickname ? 'my-message' : 'other-message';

      let contentHtml = `<strong>[${file.from}] å‘é€äº†æ–‡ä»¶ï¼š</strong> `;

      if (file.filetype.startsWith('image/')) {
        // å¦‚æœæ˜¯å›¾ç‰‡
        contentHtml += `<br><img src="${file.content}" style="max-width:200px; border-radius:8px;" />`;
      } else {
        // å…¶ä»–æ–‡ä»¶ç±»å‹
        contentHtml += `<a href="${file.content}" download="${file.filename}">${file.filename}</a>`;
      }

      item.innerHTML = contentHtml;
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });


    socket.on('private message', ({ from, msg }) => {
      const item = document.createElement('li');
      const isMe = from === nickname;
      item.id = `msg-${msg.id}`;
      item.className = isMe ? 'my-message' : 'other-message';
      // æ·»åŠ ç§èŠæ ‡è®°ï¼Œä¾‹å¦‚åœ¨æ˜µç§°å‰åŠ  "[ç§èŠ]"
      item.innerHTML = `<strong>[ç§èŠ][${from}]</strong> ${msg.text} <span class="timestamp">ï¼ˆ${msg.time}ï¼‰</span>`;
  
      if (isMe) {
        const delBtn = document.createElement('button');
        delBtn.textContent = 'æ’¤å›';
        delBtn.onclick = () => {
        socket.emit('delete message', msg.id);
      };
        item.appendChild(delBtn);
      }
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });



    socket.on('system message', ({ text, time }) => {
        const item = document.createElement('li');
        item.style.color = '#888';
        item.style.fontStyle = 'italic';
        item.innerHTML = `${text} <span style="font-size: 12px; color: #aaa;">ï¼ˆ${time}ï¼‰</span>`;
        messages.appendChild(item);
        messages.scrollTop = messages.scrollHeight;
    });

    socket.on('delete message', (id) => {
      const target = document.getElementById(`msg-${id}`);
      if (target) target.remove();
    });

    const themeBtn = document.getElementById('toggle-theme');

    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');

      if (document.body.classList.contains('dark-mode')) {
        themeBtn.textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
      } else {
        themeBtn.textContent = 'ğŸŒ™ å¤œé—´æ¨¡å¼';
      }

      // å¯é€‰è®°å¿†åŠŸèƒ½
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });

    // é¡µé¢åŠ è½½è‡ªåŠ¨æ¢å¤ä¸»é¢˜
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
      document.getElementById('toggle-theme').textContent = 'â˜€ï¸ ç™½å¤©æ¨¡å¼';
    }







</script>
  
</body>
</html>
